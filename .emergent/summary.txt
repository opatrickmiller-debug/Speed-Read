<analysis>**original_problem_statement:**
The user's initial goal was to build a Progressive Web App (PWA) called SpeedShield to provide speeding alerts. This session focused on resolving critical real-world driving inaccuracies, overhauling the mapping and data-sourcing infrastructure, and refining UI/UX based on live testing feedback.

The user added numerous requirements during the session, including: fixing data dropouts on long trips, implementing a global imperial/metric unit system, improving the predictive AI to ignore side streets, centering the speedometer UI, adding a compass, handling parking lot speed limits, and integrating the TomTom API as a commercial data fallback. The agent also proactively addressed scalability by creating self-hosting guides and making the backend configurable for production.

**User's preferred language**: English

**what currently exists?**
The application is a full-stack PWA using a React frontend and FastAPI backend. It has undergone significant enhancements to improve reliability and accuracy. Key systems include:
- **Dual Data Sources:** The backend in  primarily uses the OpenStreetMap (OSM) Overpass API for speed limits. It now features a proactive fallback to the TomTom Routing API (using a user-provided key) whenever OSM provides a low-confidence estimated speed, not just when data is completely missing.
- **Advanced Caching & Rate Limiting:** The backend features a high-performance in-memory cache, a rate limit of 200 requests/minute, and debugging endpoints (, ). The frontend () employs an exponential backoff retry mechanism to gracefully handle external API rate limits.
- **Smart Predictive AI:** The  endpoint has been rewritten to use the vehicle's current road type (e.g., ) and direction of travel to filter out irrelevant predictions from cross streets, ramps, and overpasses.
- **Refined UI/UX:** The main speedometer HUD is now dynamically centered on the viewport for all devices. A simplified compass shows the direction of travel and can be toggled off in settings. The app features a global imperial/metric unit system, and the speed limit display automatically hides in parking lots.
- **Polling Optimizations:** The frontend in  stops polling for speed limits when the vehicle is stationary to conserve data and API calls, and includes logic to prevent displaying stale data after stopping.

**Last working item**:
-   **Last item agent was working:** The agent was addressing the user's report that the app becomes unreliable on longer drives. The root cause was diagnosed as rate limiting from the free Overpass API servers. The agent implemented a fix by adding exponential backoff and more robust error-handling logic to the API polling function () in . Additionally, the backend road-finding logic in  was tightened to better handle parallel roads.
-   **Status**: USER VERIFICATION PENDING
-   **Agent Testing Done**: Y
-   **Which testing method agent to use?**: Manual testing by user (live drive test). The user needs to confirm if the app is more stable on a long trip.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1:** (P0) Application reliability degrades over long trips.
-   **Issue 2:** (P1) OpenStreetMap data can be incomplete or inaccurate for certain roads.
-   **Issue 3:** (P2) The preview environment suffers from a recurring Wake up servers loop.

**Issues Detail:**
-   **Issue 1:**
    -   **Description:** The app becomes less reliable and may stop updating speed limits during long drives. This was diagnosed as intermittent rate limiting from the public Overpass API servers.
    -   **Attempted fixes:** The  function in  was enhanced with a retry mechanism using exponential backoff to handle API errors more gracefully and prevent spamming the server.
    -   **Next debug checklist:** The user needs to perform a long drive test (30+ minutes). The agent should monitor backend logs and the  endpoint to see if the app recovers from API failures without permanently dropping data.
    -   **Why fix this issue and what will be achieved with the fix?** This is critical for the app's core functionality, ensuring it remains useful for realistic trip durations.
    -   **Status**: USER VERIFICATION PENDING
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Frontend (live user test).
-   **Issue 2:**
    -   **Description:** The primary data source, OSM, sometimes lacks explicit speed limit data, causing the app to show estimated or incorrect speeds.
    -   **Attempted fixes:** The TomTom API has been integrated as a proactive fallback in . It is now triggered not just on complete data failure from OSM, but also when OSM provides a low-confidence estimated value.
    -   **Next debug checklist:** The user needs to verify during a drive if speed limits are more accurate on roads that previously had issues. The agent can add more logging to  to confirm when TomTom is being used.
    -   **Why fix this issue and what will be achieved with the fix?** To provide the most accurate speed limit data possible, which is the app's primary purpose.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Both (live user test and backend log monitoring).
-   **Issue 3:**
    -   **Description:** A known platform-level issue with the preview environment that causes server restarts, not an application bug.
    -   **Attempted fixes:** N/A. The agent correctly informed the user that deployment is the only permanent solution and created a self-hosting guide.
    -   **Next debug checklist:** If the user brings it up again, reiterate that deploying the application is the definitive solution.
    -   **Why fix this issue and what will be achieved with the fix?** Deployment provides a stable 24/7 environment, which is necessary for a production app.
    -   **Status**: BLOCKED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** N/A.

**In progress Task List**:
-   None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P0) Comprehensive End-to-End Live Test:** The user needs to conduct a long drive to verify all recent fixes: long-trip reliability, TomTom fallback accuracy, improved AI prediction filtering, and UI stability.
    -   **(P1) Production Deployment:** Guide the user through deploying the application to a stable production environment using the  to eliminate platform issues.
-   **Future Tasks:**
    -   **(P2) Persistent Caching:** For a deployed, multi-user app, replace the in-memory Python cache with a persistent solution like Redis.
    -   **(P2) Self-Host Overpass API:** If the app scales to many users, follow the  to set up a private Overpass server to avoid public rate limits.
    -   **(P3) Apple CarPlay & Android Auto Support:** Implement native integrations based on the architecture documents in .

**Completed work in this session**
-   **Reliability & Caching Overhaul:** Increased backend rate limits, implemented advanced caching, and added exponential backoff retry logic to the frontend (, ).
-   **TomTom API Integration:** Integrated TomTom as a proactive fallback data source when OSM data is estimated ().
-   **Predictive AI Improvements:** Rewrote the prediction logic to use road type and direction of travel to filter out irrelevant side streets and ramps (, ).
-   **Global Unit System (Imperial/Metric):** Created a central utility () and updated all relevant components for consistent unit display.
-   **UI/UX Enhancements:**
    -   **Centered Speedometer:** Reworked the HUD to default to a centered position on all devices ().
    -   **Compass:** Added a simplified compass and confirmed its toggle exists in settings (, ).
    -   **Parking Lot Mode:** The speed limit sign now auto-hides in parking lots ().
-   **Polling Optimizations:** Stopped polling when stationary and fixed bugs related to displaying stale data after stopping ().
-   **Production Preparedness:** Created self-hosting and scalability guides () and made the backend Overpass URL configurable.

**Earlier issues found/mentioned but not fixed**
-   None. The agent was thorough in addressing all user-reported issues.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** OpenStreetMap data incompleteness.
-   **Recurrence count:** High.
-   **Status:** IN PROGRESS (Mitigated by TomTom integration, but not fully resolved).
-   **Issue recurrence in previous fork:** Wake up servers loop.
-   **Recurrence count:** High.
-   **Status:** BLOCKED (Platform issue).

**Code Architecture**


**Key Technical Concepts**
-   **API Rate Limiting & Backoff:** Implemented exponential backoff on the frontend to gracefully handle server-side rate limits from the external Overpass API.
-   **Proactive API Fallback:** Enhanced the data fetching logic to use a premium data source (TomTom) when the primary source (OSM) provides low-confidence (estimated) data, rather than only on complete failure.
-   **Geospatial Filtering:** Advanced the AI prediction by using the current road's  tag and bearing to filter out irrelevant upcoming road segments.
-   **Viewport-Relative Centering:** Fixed a cross-device UI issue by using JavaScript viewport calculations for default component positioning instead of CSS transforms.

**key DB schema**
-   No changes were made to the database schema.

**changes in tech stack**
-   No new libraries were added.

**All files of reference**
-   : The core of all data logic (caching, API fallbacks, prediction).
-   : The main state management hub for the UI (polling, error handling).
-   : Logic for the centered speedometer.
-   : Centralized unit conversion.
-   : Instructions for production deployment.

**Areas that need refactoring**:
-    is excessively large and complex. The logic for API polling, geolocation, and trip state should be extracted into custom hooks (e.g., , ) to improve maintainability.

**key api endpoints**
-   : Overhauled to use TomTom as a proactive fallback and return .
-   : Rewritten for much higher accuracy using road type and directional filtering.
-   : (New) For debugging cache performance.
-   : (New) To show the current data source configuration.

**Critical Info for New Agent**
-   **Reliability is the current focus.** The main problem is data dropouts from Overpass API rate limiting. The last agent implemented frontend retry logic (), but this needs verification via a long user drive test.
-   **TomTom is a PROACTIVE fallback.** The logic in  now uses TomTom when OSM provides a low-confidence *estimated* speed, not just on complete failure. This is a key part of the accuracy strategy.
-   **AI Prediction is much smarter.** It now uses the current road type to filter out side streets. This logic is in .
-   **The app is configured for production.** The agent created guides for self-hosting and made the backend configurable. The next logical step after testing is to guide the user through deployment.

**documents and test reports created in this job**
-   
-   
-    (updated)

**Last 10 User Messages and any pending HUMAN messages**
-   10. **User:** Why does the app get less reliable the longer I use it? (COMPLETED - Agent diagnosed rate limiting and implemented fixes).
-   9. **User:** Can we test the TomTom fallback? (COMPLETED - Agent tested and improved the fallback logic).
-   8. **User:** Now it's not functioning, posted speed doesn't update and it picks up parallel streets. (COMPLETED - Agent fixed a regression in frontend polling logic and tightened backend geometry search).
-   7. **User:** Stopped at a light, speed cached and never recovered. (COMPLETED - Agent fixed a bug with stale last known data when stationary).
-   6. **User:** Can we change the predictive AI threshold to 35 mph? (COMPLETED).
-   5. **User:** Can we disable the posted speed in parking lots? (COMPLETED - Agent implemented auto-hide for  roads).
-   4. **User:** Can we add a toggle to disable the compass? (COMPLETED - Agent found the existing toggle).
-   3. **User:** Can we just have the compass show the direction of travel? (COMPLETED - Agent simplified the compass UI).
-   2. **User:** The compass shows West in the South position. (COMPLETED - Agent fixed the compass rotation logic).
-   1. **User:** Missing compass on screen. Can we eliminate perpendicular cross streets? (COMPLETED - Agent fixed compass visibility and tightened the prediction filter).

**Project Health Check:**
-   **Broken:** The preview environment remains unreliable due to the platform's Wake up servers loop. The application itself is functional but needs live testing.
-   **Mocked**: None.

**3rd Party Integrations**
-   **OpenStreetMap Overpass API**: Primary source for speed limit data.
-   **OpenStreetMap Tile Server (via Leaflet)**: Used for map display.
-   **Weather.gov API**: For weather alerts (no key required).
-   **Resend**: For sending password reset emails (requires User API Key).
-   **TomTom Routing API**: **(Implemented)**. Secondary/backup source for speed limit data (requires User API Key).

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: None.
-   **Known regressions**: A recent fix for stationary polling caused a brief regression where speed limits stopped updating. This was caught and fixed by the agent.

**Credentials to test flow:**
-   It is recommended to register a new user via the UI for testing if required.

**What agent forgot to execute**
-   Nothing. The agent was exceptionally thorough, addressing every user request and proactively preparing the application for production scalability.</analysis>
