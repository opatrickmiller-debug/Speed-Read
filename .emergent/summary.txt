<analysis>**original_problem_statement:**
The user's initial goal was to build a Progressive Web App (PWA) called SpeedShield to provide speeding alerts. This expanded to include fixing real-world driving inaccuracies, overhauling the data-sourcing infrastructure, improving long-trip reliability, enhancing UI/UX based on live testing, and preparing the application for potential public deployment by addressing scalability concerns.

**PRODUCT REQUIREMENTS added in this session:**
- **Fix Data Dropouts:** Resolve an issue where the app stops receiving data after ~10 minutes of use.
- **Improve Long-Trip Reliability:** Ensure the app remains functional and accurate for drives of an hour or longer.
- **Stop Polling When Stationary:** Add an optimization to prevent API calls when the vehicle is not moving.
- **Universal Unit System:** Make the Imperial (mph/mi) vs. Metric (km/h/km) setting apply to all distances and speeds throughout the app, including trip history and AI predictions.
- **Improve AI Prediction Accuracy:** Prevent the AI prediction feature from showing speed limits of irrelevant side streets or overpasses when driving on a highway.
- **Prepare for Self-Hosting:** Create documentation and make necessary code changes to allow the user to self-host the backend, including a private Overpass API instance.
- **Center Speedometer:** Default the speedometer's position to the center of the screen, especially on mobile devices.
- **Fix/Improve Compass:** Add a visible compass to the UI and ensure it correctly displays the direction of travel.
- **Auto-hide Speed Limit in Parking Lots:** Automatically hide the speed limit display when the app detects the user is in a low-speed service area like a parking lot.

**User's preferred language**: English

**what currently exists?**
The application is a full-stack PWA using React and FastAPI. The backend () has sophisticated logic for determining speed limits, featuring a primary data source (OpenStreetMap via Overpass API) and a commercial fallback (TomTom API). It uses advanced geometry-based road detection (), robust caching, and rate limiting (). The AI speed prediction feature has been significantly improved to filter roads by type and direction of travel. The frontend () is highly dynamic, with features like a sticky speed limit display, error handling with exponential backoff, and optimizations to reduce data polling when stationary. A comprehensive unit conversion system () ensures all speeds and distances respect the user's Imperial/Metric preference. The UI includes a draggable speedometer, a compass, and various informational panels. The app has also been prepared for self-hosting with documentation and a configurable backend.

**Last working item**:
- **Last item agent was working:** The user reported that the application was performing worse after the agent changed the TomTom API fallback logic. The agent had modified  to proactively call TomTom not just when OSM returned *no data*, but also when it returned an *estimated* speed limit. The user stated the previous logic was better. The agent's last action was attempting to debug and test this new, problematic fallback logic.
- **Status**: BLOCKED
- **Agent Testing Done**: N (The change was deployed, but user testing revealed a regression.)
- **Which testing method agent to use?**: backend testing agent
- **User Testing Done**: Y (User reported the regression.)

**All Pending/In progress Issue list**:
- **Issue 1:** (P0) Major regression in speed limit accuracy after TomTom fallback logic change.
- **Issue 2:** (P1) Recurring Wake up servers loop in the preview environment.

**Issues Detail:**
- **Issue 1:**
  - **Description:** After the agent changed the TomTom API fallback to be more proactive (triggering when OSM provides an estimated speed, not just when it provides no data), the user reported that the app is not working as well as before. This suggests the new logic is introducing inaccuracies or performance issues.
  - **Attempted fixes:** The agent implemented the proactive fallback logic in . This change is the source of the problem.
  - **Next debug checklist:**
    1.  Use commit b300296164751786f93327925830e1e80d5d4275
Author: emergent-agent-e1 <github@emergent.sh>
Date:   Wed Dec 31 17:29:16 2025 +0000

    auto-commit for 7c1c8cdd-bf03-4500-9897-da675d528ef5

diff --git a/backend/server.py b/backend/server.py
index 2fbdabd..e3bc6e9 100644
--- a/backend/server.py
+++ b/backend/server.py
@@ -1233,6 +1233,19 @@ async def get_speed_limit(request: Request, lat: float, lon: float):
                 estimated_limit = HIGHWAY_SPEED_DEFAULTS.get(highway_type)
                 
                 if estimated_limit:
+                    # OSM only has road type, no explicit speed limit
+                    # Try TomTom for a more accurate limit before falling back to estimation
+                    if TOMTOM_API_KEY:
+                        logger.info(f"OSM has no explicit limit - trying TomTom for {lat}, {lon}")
+                        tomtom_result = await get_speed_limit_from_tomtom(lat, lon)
+                        if tomtom_result and tomtom_result.get("speed_limit"):
+                            # TomTom has data - use it with road name from OSM
+                            tomtom_result["road_name"] = road_name
+                            tomtom_result["road_type"] = highway_type
+                            set_cached_speed_limit(lat, lon, tomtom_result)
+                            return SpeedLimitResponse(**tomtom_result)
+                    
+                    # Fall back to estimation
                     result = {
                         "speed_limit": estimated_limit,
                         "unit": "mph", or a similar method to view the exact changes made to the fallback logic in the last few commits.
    2.  Identify the code block where the condition to call  was changed. The original logic likely only called it on a complete failure from OSM, while the new logic calls it if .
    3.  Revert this specific logic to its previous state, where TomTom is only called if the primary OSM lookup (including geometry search and estimation) fails entirely to find any road or speed.
    4.  Thoroughly test the reverted logic using the backend testing agent to confirm both OSM-only and TomTom-fallback scenarios work as expected.
  - **Why fix this issue and what will be achieved with the fix?** This is a critical regression reported by the user that degrades the core functionality of the app. Fixing it will restore the app's reliability and accuracy to the previously accepted level.
  - **Status**: IN PROGRESS
  - **Is recurring issue?** N
  - **Should Test frontend/backend/both after fix?** Backend
  - **Blocked on other issue:** None

- **Issue 2:**
  - **Description:** The Emergent platform's preview environment repeatedly shows a Wake up servers overlay, which can interrupt testing and reset the backend's in-memory cache.
  - **Attempted fixes:** This is a known platform behavior.
  - **Next debug checklist:** The only definitive solution is to **deploy the application**, which provides 24/7 uptime. This should be communicated to the user as the final solution.
  - **Why fix this issue and what will be achieved with the fix?** Deployment provides a stable environment for production use and eliminates interruptions.
  - **Status**: BLOCKED (by platform behavior)
  - **Is recurring issue?** Y
  - **Should Test frontend/backend/both after fix?** N/A
  - **Blocked on other issue:** None

**In progress Task List**:
- None

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
  - **P1: Deploy the Application:** To resolve the recurring Wake up servers issue and provide a stable production environment.
  - **P1: Final End-to-End Testing:** After the P0 regression is fixed, conduct a comprehensive live drive test to ensure all features work together seamlessly.
- **Future Tasks:**
  - **P2: Apple CarPlay Support:** Implement Apple CarPlay integration based on .
  - **P2: Android Auto App:** Build a native Android app for full Android Auto integration based on .
  - **P3: Persistent Cache:** For a deployed app, consider replacing the in-memory Python cache with a persistent solution like Redis to survive server restarts.

**Completed work in this session**
- **Long-Trip Reliability Fix:** Resolved the data dropout issue by increasing the backend API rate limit in  from 30/min to 200/min and implementing robust caching.
- **Frontend Reliability Fix:** Implemented exponential backoff and retry logic in  within  to gracefully handle temporary API server failures.
- **Universal Unit System:** Created  and refactored the entire app (, , , ) to consistently display distances and speeds in the user's selected Imperial or Metric units.
- **AI Prediction Accuracy:** Rewrote the speed prediction logic in  to be significantly more accurate by filtering upcoming roads based on the current road's type (, , etc.) and the vehicle's direction of travel.
- **Stationary Polling Optimization:** Modified  to stop polling for speed limit data when the vehicle is stationary (<2 mph), reducing unnecessary API calls.
- **Production/Self-Hosting Prep:** Created , made the backend Overpass server URL configurable via , and added the TomTom API key.
- **UI/UX Improvements:**
  - **Centered Speedometer:** Reworked  to reliably center the speedometer on page load across devices.
  - **Compass Added & Fixed:** Added a compass to the UI, fixed its orientation, and simplified its design based on user feedback. A toggle was confirmed to exist in settings.
  - **Parking Lot Auto-Hide:** Implemented logic in  to automatically hide the speed limit display on service roads (e.g., parking lots).
  - **AI Threshold Adjustment:** Changed the AI prediction activation threshold from 45 mph to 35 mph as requested.
- **Bug Fixes:**
  - Fixed a bug where stale LAST KNOWN data would persist incorrectly when stopped at a traffic light.
  - Tuned the backend road-detection geometry to better handle adjacent/parallel streets.

**Earlier issues found/mentioned but not fixed**
- None.

**Known issue recurrence from previous fork**
- **Issue recurrence:** The Wake up servers loop in the preview environment.
- **Recurrence count:** 2+
- **Status:** BLOCKED (Solution is deployment)

**Code Architecture**


**Key Technical Concepts**
- **API Rate Limiting:** Using  on the backend to control request frequency, which was a critical fix.
- **Exponential Backoff:** Implemented on the frontend to create a resilient client that can recover from temporary server-side API errors or rate limiting.
- **Context-Aware API Logic:** The AI speed prediction now uses context (current road type, direction) to provide much more relevant results.
- **Proactive API Fallback:** The (currently problematic) strategy of using a secondary API not just on failure, but when the primary API returns low-confidence (estimated) data.
- **Viewport-Based Centering:** Using / in React to reliably position elements, overcoming CSS transform inconsistencies.
- **Centralized Utilities:** Creating a  file to enforce consistency and DRY principles for unit conversion.

**key DB schema**
- No changes were made to the database schema.

**changes in tech stack**
- No new libraries were added, but the use of the existing  Python library became critical.

**All files of reference**
- : The heart of the application logic. The recent regression is located here in the  function's fallback logic.
- : The core frontend component managing state, API calls, and user interactions.
- : The component responsible for the now-fixed speedometer positioning.
- : The new, critical utility for ensuring consistent units across the app.
- : New documentation for user-managed deployment.

**Critical Info for New Agent**
- **Your IMMEDIATE and HIGHEST priority (P0) is to fix the regression reported by the user.** The app is not working as well since the TomTom fallback logic was changed to be more proactive. You must investigate the last few commits to  and likely revert the fallback condition to only trigger on a complete lack of data from OSM, rather than on an estimated result.
- The AI Prediction accuracy is now highly dependent on the  being correctly identified and passed from the frontend. Any changes to the speed limit logic must preserve this data flow.
- The Wake up servers issue is a known platform limitation. The solution is to advise the user to deploy the application, not to attempt code fixes.
- The user has been very involved in live testing. Be prepared to deploy changes and ask for another drive test once the regression is fixed.

**documents and test reports created in this job**
- 
- 
-  (updated)

**Last 10 User Messages and any pending HUMAN messages**
- 10. **User:** The longer I use the app the less reliable it becomes, why? - This led to the agent diagnosing Overpass rate limiting and adding exponential backoff.
- 9. **Agent:** Summarizes the fix for reliability issues (exponential backoff).
- 8. **User:** Can we test the tom tom fallback? - This initiated the sequence that led to the regression.
- 7. **Agent:** Tests and finds TomTom is rarely used. Proposes a more proactive fallback.
- 6. **Agent:** Implements the proactive TomTom fallback logic.
- 5. **Agent:** Tests the new logic, but tests are inconclusive.
- 4. **Agent:** Summarizes that the TomTom fallback is ready.
- 3. **User:** Can you compare the code from before we updated the tom tom fallback to the current version. It is not working as well as before that change - **THIS IS THE CRITICAL BLOCKING MESSAGE.**
- 2. **Agent:** Acknowledges the request to compare/revert the change.
- 1. **Agent:** Starts investigating the git history to revert the change.

**Project Health Check:**
- **Broken**: The application's core feature (speed limit accuracy) has a major user-reported regression. The last change made by the previous agent broke the system's reliability.

**3rd Party Integrations**
- **OpenStreetMap Overpass API**: Primary source for speed limit data.
- **OpenStreetMap Tile Server (via Leaflet)**: Used for map display.
- **Weather.gov API**: For weather alerts.
- **Resend**: For password reset emails.
- **TomTom API**: **Integrated, but the current implementation logic is causing a critical regression.** Requires User API Key.

**Testing status**
- **Testing agent used after significant changes**: YES
- **Troubleshoot agent used after agent stuck in loop**: NO
- **Test files created**: None.
- **Known regressions**: [**CRITICAL**] The proactive TomTom fallback logic introduced in the last few steps has made the app less accurate/reliable, as reported by the user.

**Credentials to test flow:**
- User credentials for testing are not fixed; it is recommended to register a new user via the UI if login is required.

**What agent forgot to execute**
- The agent did not forget to execute anything, but its last executed action (modifying the TomTom fallback logic) was flawed and introduced a critical regression that must be addressed immediately. It failed to test the new logic thoroughly enough to catch the degradation in performance before the user did.</analysis>
